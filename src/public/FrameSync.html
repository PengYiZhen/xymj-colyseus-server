<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸§åŒæ­¥æ¼”ç¤º - å°æ¸¸ç åŒ </title>
    <!-- Colyseus å®¢æˆ·ç«¯åº“ -->
    <script src="https://unpkg.com/colyseus.js@^0.16.0/dist/colyseus.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            padding: 30px 20px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .status-item label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .status-item value {
            display: block;
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button.danger {
            background: #dc3545;
        }

        .button.danger:hover {
            background: #c82333;
        }

        .button.success {
            background: #28a745;
        }

        .button.success:hover {
            background: #218838;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .log-container {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }

        .log-entry.info {
            border-left-color: #17a2b8;
        }

        .log-entry.success {
            border-left-color: #28a745;
        }

        .log-entry.error {
            border-left-color: #dc3545;
        }

        .log-entry.warning {
            border-left-color: #ffc107;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        .status-log-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
            width: 100%;
        }

        /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šæ‰æ¢è¡Œ */
        @media (max-width: 1200px) {
            .status-log-row {
                grid-template-columns: 1fr;
            }
        }

        /* è®©å³ä¾§åˆ—å æ®æ›´å¤šç©ºé—´ï¼Œæ¨ªå‘æ’åˆ— */
        .grid-container > div:last-child {
            grid-column: span 1;
            width: 100%;
        }

        @media (min-width: 1401px) {
            .grid-container {
                grid-template-columns: 1fr 1.2fr 2fr;
            }
        }

        .input-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .input-button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .input-button:hover {
            background: #138496;
        }

        .input-button.active {
            background: #28a745;
        }

        .canvas-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            position: relative;
        }

        #gameCanvas {
            width: 100%;
            max-width: 800px;
            height: 500px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: #2d2d2d;
            display: block;
            margin: 0 auto;
        }

        .canvas-info {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .player {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1.2fr 2fr;
            gap: 20px;
        }

        @media (max-width: 1400px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        
        <div class="header">
            <h1>âš™ï¸ å¸§åŒæ­¥æ¼”ç¤º</h1>
            <p>å®æ—¶å¤šäººæ¸¸æˆå¸§åŒæ­¥åŠŸèƒ½æ¼”ç¤º</p>
        </div>

        <div class="grid-container">
            <!-- å·¦ä¾§ï¼šè¿æ¥å’Œæ§åˆ¶ -->
            <div>
                <div class="card">
                    <h2>ğŸ”Œ è¿æ¥è®¾ç½®</h2>
                    <div class="input-group">
                        <label>æœåŠ¡å™¨åœ°å€</label>
                        <input type="text" id="serverUrl" value="ws://localhost:2567" placeholder="ws://localhost:2567">
                    </div>
                    <div class="input-group">
                        <label>æˆ¿é—´åç§°</label>
                        <select id="roomName">
                            <option value="game_room">game_room (å¸§åŒæ­¥æˆ¿é—´)</option>
                            <option value="my_room">my_room (æ™®é€šæˆ¿é—´)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>è¿æ¥é€‰é¡¹</label>
                        <input type="text" id="roomOptions" value='{"fps": 20}' placeholder='{"fps": 20}'>
                    </div>
                    <button class="button" id="connectBtn" onclick="connectRoom()">è¿æ¥æˆ¿é—´</button>
                    <button class="button danger" id="disconnectBtn" onclick="disconnectRoom()" disabled>æ–­å¼€è¿æ¥</button>
                </div>

                <div class="card">
                    <h2>ğŸ® è¾“å…¥æ§åˆ¶</h2>
                    <div class="input-controls">
                        <button class="input-button" id="moveUp" onmousedown="sendInput('move', {x: 0, y: -1})" onmouseup="sendInput('move', {x: 0, y: 0})">â†‘ ä¸Š</button>
                        <button class="input-button" id="moveDown" onmousedown="sendInput('move', {x: 0, y: 1})" onmouseup="sendInput('move', {x: 0, y: 0})">â†“ ä¸‹</button>
                        <button class="input-button" id="moveLeft" onmousedown="sendInput('move', {x: -1, y: 0})" onmouseup="sendInput('move', {x: 0, y: 0})">â† å·¦</button>
                        <button class="input-button" id="moveRight" onmousedown="sendInput('move', {x: 1, y: 0})" onmouseup="sendInput('move', {x: 0, y: 0})">â†’ å³</button>
                        <button class="input-button" onclick="sendInput('attack', true)">âš”ï¸ æ”»å‡»</button>
                        <button class="input-button" onclick="sendInput('jump', true)">ğŸ¦˜ è·³è·ƒ</button>
                    </div>
                    <div style="margin-top: 15px;">
                        <label>è‡ªå®šä¹‰è¾“å…¥ (JSON)</label>
                        <input type="text" id="customInput" placeholder='{"action": "custom", "data": {}}' style="margin-top: 5px;">
                        <button class="button" onclick="sendCustomInput()" style="width: 100%; margin-top: 10px;">å‘é€è‡ªå®šä¹‰è¾“å…¥</button>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šCanvas æ¸¸æˆè§†å›¾ -->
            <div>
                <div class="card">
                    <h2>ğŸ® æ¸¸æˆè§†å›¾</h2>
                    <div class="canvas-container">
                        <canvas id="gameCanvas" width="800" height="500"></canvas>
                        <div class="canvas-info">
                            <div>ä½¿ç”¨æ–¹å‘é”®æˆ– WASD æ§åˆ¶è§’è‰²ç§»åŠ¨</div>
                            <div style="margin-top: 5px;">ç©ºæ ¼é”®è·³è·ƒ | ç‚¹å‡»æŒ‰é’®å‘é€è¾“å…¥</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šçŠ¶æ€å’Œæ—¥å¿— -->
            <div>
                <div class="status-log-row">
                    <div class="card">
                        <h2>ğŸ“Š è¿æ¥çŠ¶æ€</h2>
                        <div class="status-grid">
                            <div class="status-item">
                                <label>è¿æ¥çŠ¶æ€</label>
                                <value id="connectionStatus">æœªè¿æ¥</value>
                            </div>
                            <div class="status-item">
                                <label>æˆ¿é—´ ID</label>
                                <value id="roomId">-</value>
                            </div>
                            <div class="status-item">
                                <label>ä¼šè¯ ID</label>
                                <value id="sessionId">-</value>
                            </div>
                            <div class="status-item">
                                <label>å½“å‰å¸§</label>
                                <value id="currentFrame">0</value>
                            </div>
                            <div class="status-item">
                                <label>ç›®æ ‡ FPS</label>
                                <value id="targetFPS">-</value>
                            </div>
                            <div class="status-item">
                                <label>å®¢æˆ·ç«¯æ•°é‡</label>
                                <value id="clientCount">0</value>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“ æ—¥å¿—</h2>
                        <button class="button" onclick="clearLog()" style="margin-bottom: 10px;">æ¸…ç©ºæ—¥å¿—</button>
                        <div class="log-container" id="logContainer" style="max-height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
            <div style="line-height: 1.8;">
                <p><strong>1. è¿æ¥æˆ¿é—´ï¼š</strong>è¾“å…¥æœåŠ¡å™¨åœ°å€å’Œæˆ¿é—´åç§°ï¼Œç‚¹å‡»"è¿æ¥æˆ¿é—´"æŒ‰é’®ã€‚</p>
                <p><strong>2. å‘é€è¾“å…¥ï¼š</strong>ä½¿ç”¨æ–¹å‘é”®æŒ‰é’®æˆ–è‡ªå®šä¹‰è¾“å…¥å‘é€æ¸¸æˆè¾“å…¥ã€‚</p>
                <p><strong>3. æŸ¥çœ‹çŠ¶æ€ï¼š</strong>å®æ—¶æŸ¥çœ‹è¿æ¥çŠ¶æ€ã€å½“å‰å¸§å·ç­‰ä¿¡æ¯ã€‚</p>
                <p><strong>4. ç›‘æ§æ—¥å¿—ï¼š</strong>æŸ¥çœ‹æ‰€æœ‰æ“ä½œå’Œæ¶ˆæ¯çš„æ—¥å¿—è®°å½•ã€‚</p>
                <p style="margin-top: 10px; color: #666;">
                    <strong>æ³¨æ„ï¼š</strong>ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”å·²å®‰è£… Colyseus å®¢æˆ·ç«¯åº“ã€‚
                    å¦‚æœä½¿ç”¨æµè§ˆå™¨ï¼Œéœ€è¦å…ˆå®‰è£…ï¼š<code>npm install colyseus.js</code>
                </p>
            </div>
        </div>
    </div>

    <script>
        let room = null;
        let client = null;
        let isConnected = false;
        
        // Canvas ç›¸å…³
        let canvas = null;
        let ctx = null;
        let players = new Map(); // å­˜å‚¨æ‰€æœ‰ç©å®¶
        let localPlayer = null;
        let animationFrameId = null;

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // æ›´æ–°æ—¥å¿—æ•°é‡
            updateLogCount();
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            updateLogCount();
            addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        function updateLogCount() {
            const logContainer = document.getElementById('logContainer');
            const logCount = document.getElementById('logCount');
            if (logContainer && logCount) {
                const count = logContainer.children.length;
                logCount.textContent = `(${count})`;
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            document.getElementById('connectionStatus').textContent = isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
            document.getElementById('roomId').textContent = room ? room.roomId : '-';
            document.getElementById('sessionId').textContent = room ? room.sessionId : '-';
            document.getElementById('clientCount').textContent = room && room.clients ? room.clients.length : '0';
        }

        // è¿æ¥æˆ¿é—´
        async function connectRoom() {
            const serverUrl = document.getElementById('serverUrl').value;
            const roomName = document.getElementById('roomName').value;
            const optionsText = document.getElementById('roomOptions').value;

            if (!serverUrl) {
                alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');
                return;
            }

            // æ£€æŸ¥ Colyseus æ˜¯å¦å¯ç”¨
            if (typeof Colyseus === 'undefined') {
                addLog('âŒ Colyseus å®¢æˆ·ç«¯åº“æœªåŠ è½½', 'error');
                addLog('è¯·ç¡®ä¿å·²åŠ è½½ Colyseus.js åº“', 'error');
                addLog('å¯ä»¥é€šè¿‡ CDN: https://unpkg.com/colyseus.js@^0.16.0/dist/colyseus.js', 'info');
                return;
            }

            try {
                addLog(`æ­£åœ¨è¿æ¥åˆ° ${serverUrl}...`, 'info');
                
                // åˆ›å»ºå®¢æˆ·ç«¯
                const client = new Colyseus.Client(serverUrl);
                
                // è§£æè¿æ¥é€‰é¡¹
                let options = {};
                if (optionsText) {
                    try {
                        options = JSON.parse(optionsText);
                    } catch (e) {
                        addLog(`è§£æè¿æ¥é€‰é¡¹å¤±è´¥: ${e.message}ï¼Œä½¿ç”¨é»˜è®¤é€‰é¡¹`, 'warning');
                    }
                }
                
                // è¿æ¥æˆ¿é—´
                room = await client.joinOrCreate(roomName, options);
                isConnected = true;
                
                // è®¾ç½®æˆ¿é—´äº‹ä»¶ç›‘å¬
                room.onLeave(() => {
                    isConnected = false;
                    // æ¸…ç†å®šæ—¶å™¨
                    if (room._playerUpdateInterval) {
                        clearInterval(room._playerUpdateInterval);
                    }
                    // æ¸…ç†ç©å®¶åˆ—è¡¨
                    players.clear();
                    localPlayer = null;
                    room = null;
                    updateStatus();
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    addLog('å·²ç¦»å¼€æˆ¿é—´', 'info');
                });

                room.onError((code, message) => {
                    addLog(`æˆ¿é—´é”™è¯¯ [${code}]: ${message}`, 'error');
                });


                // ç›‘å¬å¸§åŒæ­¥æ¶ˆæ¯ï¼ˆä»…åœ¨è¿æ¥æ—¶æ¥æ”¶åˆå§‹å¸§å·ï¼‰
                room.onMessage('frameSync', (message) => {
                    if (message.currentFrame !== undefined) {
                        document.getElementById('currentFrame').textContent = message.currentFrame;
                    }
                    if (message.targetFPS !== undefined) {
                        document.getElementById('targetFPS').textContent = message.targetFPS;
                    }
                    addLog(`æ”¶åˆ°åˆå§‹å¸§åŒæ­¥: å¸§=${message.currentFrame}, FPS=${message.targetFPS}`, 'info');
                });

                // ç›‘å¬æˆ¿é—´çŠ¶æ€å˜åŒ–
                room.onStateChange((state) => {
                    // æ›´æ–°å¸§å·ï¼ˆä»æœåŠ¡å™¨çŠ¶æ€ï¼‰
                    if (state.frame !== undefined) {
                        document.getElementById('currentFrame').textContent = state.frame;
                    }
                    
                    // æ›´æ–°ç©å®¶åˆ—è¡¨å’Œä½ç½®
                    updatePlayersFromRoom();
                });
                
                // ç›‘å¬ç©å®¶åŠ å…¥æ¶ˆæ¯
                room.onMessage('playerJoined', (message) => {
                    addLog(`ç©å®¶åŠ å…¥æˆ¿é—´: ${message.sessionId.substring(0, 8)} (æ€»ç©å®¶æ•°: ${message.playerCount})`, 'success');
                    updatePlayersFromRoom();
                });
                
                // ç›‘å¬ç©å®¶ç¦»å¼€æ¶ˆæ¯
                room.onMessage('playerLeft', (message) => {
                    addLog(`ç©å®¶ç¦»å¼€æˆ¿é—´: ${message.sessionId.substring(0, 8)} (æ€»ç©å®¶æ•°: ${message.playerCount})`, 'info');
                    updatePlayersFromRoom();
                });
                
                // å®šæœŸæ›´æ–°ç©å®¶åˆ—è¡¨ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
                const playerUpdateInterval = setInterval(() => {
                    if (isConnected && room) {
                        updatePlayersFromRoom();
                    } else {
                        clearInterval(playerUpdateInterval);
                    }
                }, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
                
                // å­˜å‚¨ interval IDï¼Œä»¥ä¾¿åœ¨æ–­å¼€è¿æ¥æ—¶æ¸…ç†
                room._playerUpdateInterval = playerUpdateInterval;

                // ç›‘å¬å…¶ä»–æ¶ˆæ¯
                room.onMessage('chat', (message) => {
                    addLog(`èŠå¤©æ¶ˆæ¯ [${message.clientId}]: ${message.message}`, 'info');
                });
                
                // ç›‘å¬ç©å®¶æ“ä½œæ¶ˆæ¯
                room.onMessage('playerAction', (message) => {
                    const actionType = message.action || 'æœªçŸ¥æ“ä½œ';
                    const playerId = message.sessionId ? message.sessionId.substring(0, 8) : 'æœªçŸ¥';
                    const actionData = message.data ? JSON.stringify(message.data) : '';
                    addLog(`ç©å®¶æ“ä½œ [${playerId}]: ${actionType} ${actionData}`, 'info');
                });

                // æ›´æ–°æœ¬åœ°ç©å®¶IDä¸ºsessionId
                if (localPlayer) {
                    localPlayer.id = room.sessionId.substring(0, 8);
                    players.delete('local');
                    players.set(room.sessionId, localPlayer);
                }
                
                // åˆå§‹åŒ–ç©å®¶åˆ—è¡¨
                updatePlayersFromRoom();
                
                updateStatus();
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
                addLog(`âœ… æˆåŠŸè¿æ¥åˆ°æˆ¿é—´: ${roomName}`, 'success');
                addLog(`æˆ¿é—´ ID: ${room.roomId}`, 'info');
                addLog(`ä¼šè¯ ID: ${room.sessionId}`, 'info');
                
            } catch (error) {
                addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                console.error('è¿æ¥é”™è¯¯:', error);
                isConnected = false;
                room = null;
                updateStatus();
            }
        }


        // æ–­å¼€è¿æ¥
        async function disconnectRoom() {
            if (room) {
                try {
                    await room.leave();
                    addLog('å·²æ–­å¼€è¿æ¥', 'info');
                } catch (error) {
                    addLog(`æ–­å¼€è¿æ¥æ—¶å‡ºé”™: ${error.message}`, 'error');
                }
                room = null;
            }
            isConnected = false;
            updateStatus();
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
        }

        // æ›´æ–°ç©å®¶åˆ—è¡¨ï¼ˆä»æˆ¿é—´çŠ¶æ€ï¼‰- å®Œå…¨ä¿¡ä»»æœåŠ¡å™¨çŠ¶æ€
        function updatePlayersFromRoom() {
            if (!room || !canvas) return;
            
            // ä»æˆ¿é—´çŠ¶æ€è·å–ç©å®¶ä¿¡æ¯
            const clientIds = new Set();
            
            // ä»æˆ¿é—´çŠ¶æ€è·å–ç©å®¶ä¿¡æ¯ï¼ˆä¸»è¦æ–¹æ³•ï¼‰
            if (room.state && room.state.players) {
                // Colyseus çš„ MapSchema å¯ä»¥é€šè¿‡ forEach éå†
                if (room.state.players.forEach) {
                    room.state.players.forEach((statePlayer, sessionId) => {
                        if (statePlayer && sessionId) {
                            clientIds.add(sessionId);
                            
                            // åˆ›å»ºæˆ–æ›´æ–°ç©å®¶ï¼ˆå®Œå…¨ä»æœåŠ¡å™¨çŠ¶æ€åŒæ­¥ï¼‰
                            if (!players.has(sessionId)) {
                                // åˆ›å»ºæ–°ç©å®¶
                                const isLocal = sessionId === room.sessionId;
                                const newPlayer = {
                                    id: sessionId.substring(0, 8),
                                    x: statePlayer.x || canvas.width / 2,
                                    y: statePlayer.y || canvas.height / 2,
                                    color: isLocal ? '#667eea' : `hsl(${Math.random() * 360}, 70%, 50%)`,
                                    radius: 15,
                                    vx: 0,
                                    vy: 0,
                                    speed: 3
                                };
                                players.set(sessionId, newPlayer);
                                
                                if (isLocal && !localPlayer) {
                                    localPlayer = newPlayer;
                                }
                                
                                addLog(`ç©å®¶åŠ å…¥: ${sessionId.substring(0, 8)}`, 'success');
                                console.log(`åˆ›å»ºç©å®¶: ${sessionId.substring(0, 8)}`, newPlayer);
                            } else {
                                // æ›´æ–°ç°æœ‰ç©å®¶ä½ç½®ï¼ˆå®Œå…¨ä¿¡ä»»æœåŠ¡å™¨çŠ¶æ€ï¼‰
                                const localPlayerObj = players.get(sessionId);
                                // å¸§åŒæ­¥ï¼šæ‰€æœ‰ç©å®¶ä½ç½®éƒ½ä»æœåŠ¡å™¨åŒæ­¥
                                localPlayerObj.x = statePlayer.x || localPlayerObj.x;
                                localPlayerObj.y = statePlayer.y || localPlayerObj.y;
                                // æ¸…é™¤æœ¬åœ°é€Ÿåº¦ï¼Œå› ä¸ºä½ç½®ç”±æœåŠ¡å™¨å†³å®š
                                localPlayerObj.vx = 0;
                                localPlayerObj.vy = 0;
                            }
                        }
                    });
                } else if (typeof room.state.players === 'object') {
                    // å¤‡ç”¨æ–¹æ³•ï¼šå¦‚æœæ˜¯æ™®é€šå¯¹è±¡
                    Object.keys(room.state.players).forEach(sessionId => {
                        const statePlayer = room.state.players[sessionId];
                        if (statePlayer && sessionId) {
                            clientIds.add(sessionId);
                            
                            // åˆ›å»ºæˆ–æ›´æ–°ç©å®¶
                            if (!players.has(sessionId)) {
                                const isLocal = sessionId === room.sessionId;
                                const newPlayer = {
                                    id: sessionId.substring(0, 8),
                                    x: statePlayer.x || canvas.width / 2,
                                    y: statePlayer.y || canvas.height / 2,
                                    color: isLocal ? '#667eea' : `hsl(${Math.random() * 360}, 70%, 50%)`,
                                    radius: 15,
                                    vx: 0,
                                    vy: 0,
                                    speed: 3
                                };
                                players.set(sessionId, newPlayer);
                                
                                if (isLocal && !localPlayer) {
                                    localPlayer = newPlayer;
                                }
                                
                                addLog(`ç©å®¶åŠ å…¥: ${sessionId.substring(0, 8)}`, 'success');
                            } else {
                                const localPlayerObj = players.get(sessionId);
                                localPlayerObj.x = statePlayer.x || localPlayerObj.x;
                                localPlayerObj.y = statePlayer.y || localPlayerObj.y;
                                localPlayerObj.vx = 0;
                                localPlayerObj.vy = 0;
                            }
                        }
                    });
                }
            }
            
            // æ€»æ˜¯æ·»åŠ å½“å‰å®¢æˆ·ç«¯ï¼ˆå¦‚æœä¸åœ¨åˆ—è¡¨ä¸­ï¼‰
            if (room.sessionId && !clientIds.has(room.sessionId)) {
                clientIds.add(room.sessionId);
            }
            
            const clientIdsArray = Array.from(clientIds);
            
            // ç§»é™¤å·²ç¦»å¼€çš„ç©å®¶
            const playersToRemove = [];
            players.forEach((player, sessionId) => {
                if (!clientIdsArray.includes(sessionId)) {
                    playersToRemove.push(sessionId);
                }
            });
            
            playersToRemove.forEach(sessionId => {
                players.delete(sessionId);
                if (sessionId === room.sessionId) {
                    localPlayer = null;
                }
                addLog(`ç©å®¶ç¦»å¼€: ${sessionId.substring(0, 8)}`, 'info');
                console.log(`ç§»é™¤ç©å®¶: ${sessionId.substring(0, 8)}`);
            });
            
            // æ›´æ–°å®¢æˆ·ç«¯æ•°é‡æ˜¾ç¤º
            if (document.getElementById('clientCount')) {
                document.getElementById('clientCount').textContent = clientIdsArray.length;
            }
        }

        // å‘é€è¾“å…¥
        function sendInput(type, data) {
            if (!isConnected || !room) {
                addLog('è¯·å…ˆè¿æ¥æˆ¿é—´', 'warning');
                return;
            }

            const input = {
                [type]: data
            };

            // æ³¨æ„ï¼šå¸§åŒæ­¥æ¨¡å¼ä¸‹ï¼Œä¸è¿›è¡Œä¹è§‚æ›´æ–°
            // æ‰€æœ‰ä½ç½®æ›´æ–°éƒ½ç”±æœåŠ¡å™¨ç«¯è®¡ç®—ï¼Œå®¢æˆ·ç«¯åªè´Ÿè´£æ˜¾ç¤º
            // handleInput(input); // æ³¨é‡Šæ‰ä¹è§‚æ›´æ–°

            try {
                room.send('input', {
                    inputs: input,
                    timestamp: Date.now()
                });
                
                // æ˜¾ç¤ºæ“ä½œä¿¡æ¯ï¼ˆé‡è¦æ“ä½œï¼‰
                if (type === 'attack' || type === 'jump') {
                    addLog(`å‘é€æ“ä½œ [${type}]: ${JSON.stringify(data)}`, 'success');
                } else if (type === 'move' && (data.x !== 0 || data.y !== 0)) {
                    // ç§»åŠ¨æ“ä½œå‡å°‘æ—¥å¿—ï¼Œä½†å¯ä»¥æ˜¾ç¤ºæ–¹å‘
                    const direction = [];
                    if (data.y < 0) direction.push('ä¸Š');
                    if (data.y > 0) direction.push('ä¸‹');
                    if (data.x < 0) direction.push('å·¦');
                    if (data.x > 0) direction.push('å³');
                    if (direction.length > 0) {
                        // å‡å°‘ç§»åŠ¨æ—¥å¿—é¢‘ç‡ï¼Œé¿å…åˆ·å±
                        const now = Date.now();
                        if (!window.lastMoveLogTime || now - window.lastMoveLogTime > 500) {
                            addLog(`ç§»åŠ¨: ${direction.join('')}`, 'info');
                            window.lastMoveLogTime = now;
                        }
                    }
                }
            } catch (error) {
                addLog(`å‘é€è¾“å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å‘é€è‡ªå®šä¹‰è¾“å…¥
        function sendCustomInput() {
            const customInputText = document.getElementById('customInput').value;
            if (!customInputText) {
                alert('è¯·è¾“å…¥è‡ªå®šä¹‰è¾“å…¥');
                return;
            }

            try {
                const input = JSON.parse(customInputText);
                if (!isConnected || !room) {
                    addLog('è¯·å…ˆè¿æ¥æˆ¿é—´', 'warning');
                    return;
                }

                room.send('input', {
                    inputs: input,
                    timestamp: Date.now()
                });
                addLog(`å‘é€è‡ªå®šä¹‰è¾“å…¥: ${customInputText}`, 'success');
                document.getElementById('customInput').value = '';
            } catch (error) {
                addLog(`è§£æè¾“å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é”®ç›˜æ§åˆ¶
        const keys = {
            up: false,
            down: false,
            left: false,
            right: false
        };

        function updateMovement() {
            if (!isConnected || !localPlayer) return;
            
            let moveX = 0;
            let moveY = 0;
            
            if (keys.up) moveY -= 1;
            if (keys.down) moveY += 1;
            if (keys.left) moveX -= 1;
            if (keys.right) moveX += 1;
            
            if (moveX !== 0 || moveY !== 0) {
                sendInput('move', {x: moveX, y: moveY});
            } else if (localPlayer.vx !== 0 || localPlayer.vy !== 0) {
                sendInput('move', {x: 0, y: 0});
            }
        }

        document.addEventListener('keydown', (e) => {
            if (!isConnected) return;

            switch(e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    e.preventDefault();
                    keys.up = true;
                    updateMovement();
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    e.preventDefault();
                    keys.down = true;
                    updateMovement();
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    e.preventDefault();
                    keys.left = true;
                    updateMovement();
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    e.preventDefault();
                    keys.right = true;
                    updateMovement();
                    break;
                case ' ':
                    e.preventDefault();
                    sendInput('jump', true);
                    break;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!isConnected) return;

            switch(e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    keys.up = false;
                    updateMovement();
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    keys.down = false;
                    updateMovement();
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    keys.left = false;
                    updateMovement();
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    keys.right = false;
                    updateMovement();
                    break;
            }
        });

        // å®šæœŸå‘é€è¾“å…¥ï¼ˆå³ä½¿æ²¡æœ‰å˜åŒ–ï¼Œä¹Ÿå‘é€å½“å‰çŠ¶æ€ï¼‰
        setInterval(() => {
            if (isConnected && localPlayer) {
                updateMovement();
            }
        }, 50); // æ¯50mså‘é€ä¸€æ¬¡

        // åˆå§‹åŒ– Canvas
        function initCanvas() {
            canvas = document.getElementById('gameCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            
            // åˆ›å»ºæœ¬åœ°ç©å®¶ï¼ˆä¸´æ—¶ï¼Œè¿æ¥åä¼šæ›´æ–°ä¸ºsessionIdï¼‰
            localPlayer = {
                id: 'local',
                x: canvas.width / 2,
                y: canvas.height / 2,
                color: '#667eea',
                radius: 15,
                vx: 0,
                vy: 0,
                speed: 3
            };
            players.set('local', localPlayer);
            
            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            gameLoop();
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            if (!canvas || !ctx) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#2d2d2d';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼
            drawGrid();
            
            // æ›´æ–°ç©å®¶ä½ç½®
            updatePlayers();
            
            // ç»˜åˆ¶æ‰€æœ‰ç©å®¶
            players.forEach((player, id) => {
                drawPlayer(player);
            });
            
            // ç»˜åˆ¶ä¿¡æ¯
            drawInfo();
            
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // ç»˜åˆ¶ç½‘æ ¼
        function drawGrid() {
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;
            
            const gridSize = 50;
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // ç»˜åˆ¶ç©å®¶
        function drawPlayer(player) {
            ctx.save();
            
            // ç»˜åˆ¶ç©å®¶åœ†åœˆ
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // ç»˜åˆ¶è¾¹æ¡†
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // ç»˜åˆ¶ç©å®¶ID
            ctx.fillStyle = '#fff';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(player.id.substring(0, 8), player.x, player.y - player.radius - 5);
            
            // å¦‚æœæ˜¯æœ¬åœ°ç©å®¶ï¼Œç»˜åˆ¶ç‰¹æ®Šæ ‡è®°
            if (room && player.id === room.sessionId.substring(0, 8)) {
                ctx.strokeStyle = '#ffeb3b';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.radius + 3, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            ctx.restore();
        }

        // æ›´æ–°ç©å®¶ä½ç½®ï¼ˆå¸§åŒæ­¥æ¨¡å¼ä¸‹ï¼Œä½ç½®å®Œå…¨ç”±æœåŠ¡å™¨çŠ¶æ€å†³å®šï¼‰
        function updatePlayers() {
            // åœ¨å¸§åŒæ­¥æ¨¡å¼ä¸‹ï¼Œç©å®¶ä½ç½®åº”è¯¥å®Œå…¨ä»æœåŠ¡å™¨çŠ¶æ€åŒæ­¥
            // è¿™é‡Œä¸éœ€è¦è‡ªå·±è®¡ç®—ä½ç½®ï¼Œä½ç½®å·²ç»åœ¨ updatePlayersFromRoom() ä¸­ä»æœåŠ¡å™¨çŠ¶æ€åŒæ­¥äº†
            // ä¿ç•™æ­¤å‡½æ•°ä»¥é˜²éœ€è¦å…¶ä»–é€»è¾‘ï¼Œä½†ä½ç½®æ›´æ–°åº”è¯¥åœ¨çŠ¶æ€å˜åŒ–æ—¶å¤„ç†
        }

        // ç»˜åˆ¶ä¿¡æ¯
        function drawInfo() {
            ctx.save();
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(10, 10, 200, 100);
            
            ctx.fillStyle = '#fff';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            
            // ä» DOM æˆ–æˆ¿é—´çŠ¶æ€è·å–ä¿¡æ¯
            const frameElement = document.getElementById('currentFrame');
            const fpsElement = document.getElementById('targetFPS');
            const clientCountElement = document.getElementById('clientCount');
            
            const frame = frameElement ? frameElement.textContent : (room?.state?.frame || 0);
            const fps = fpsElement ? fpsElement.textContent : '-';
            const clientCount = clientCountElement ? clientCountElement.textContent : players.size;
            
            ctx.fillText(`å¸§: ${frame}`, 20, 30);
            ctx.fillText(`FPS: ${fps}`, 20, 50);
            ctx.fillText(`ç©å®¶: ${clientCount}`, 20, 70);
            ctx.fillText(`æœ¬åœ°ç©å®¶: ${localPlayer ? 'æ˜¯' : 'å¦'}`, 20, 90);
            
            ctx.restore();
        }

        // å¤„ç†è¾“å…¥å¹¶æ›´æ–°æœ¬åœ°ç©å®¶
        function handleInput(inputs) {
            if (!localPlayer) return;
            
            if (inputs.move) {
                localPlayer.vx = inputs.move.x * localPlayer.speed;
                localPlayer.vy = inputs.move.y * localPlayer.speed;
            }
            
            if (inputs.jump) {
                localPlayer.vy -= 5; // è·³è·ƒæ•ˆæœ
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            updateStatus();
            initCanvas();
            addLog('å¸§åŒæ­¥æ¼”ç¤ºç¨‹åºå·²å°±ç»ª', 'success');
            
            // æ£€æŸ¥ Colyseus æ˜¯å¦å·²åŠ è½½
            if (typeof Colyseus !== 'undefined') {
                addLog('âœ… Colyseus å®¢æˆ·ç«¯åº“å·²åŠ è½½', 'success');
            } else {
                addLog('âš ï¸ Colyseus å®¢æˆ·ç«¯åº“æœªåŠ è½½', 'warning');
                addLog('æ­£åœ¨å°è¯•ä» CDN åŠ è½½...', 'info');
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            if (room) {
                room.leave();
            }
        });
    </script>
</body>
</html>

